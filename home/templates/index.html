{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% load static %}
{% block content %}
<head>
    <title>Shape Map</title>
    <!-- Add Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Add Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        .form-container {
            border-radius: 15px;
            border-width: 2px;
            border-style: solid;
            border-color: rgb(165, 165, 165);
            padding-top: 5px;
            padding-bottom: 5px;
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
        }
        .map-container {
            padding: 15px
        }
        #map {
            height: 82vh;
            width: 100%;
            overflow: hidden;
            border-radius: 15px;
            border-width: 2px;
            border-style: solid;
            border-color: rgb(165, 165, 165);
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        #controls {
            margin: 10px 0;
        }
        .filter-container {
            position: absolute;
            top: 90px; /* Adjust as needed */
            left: 72%;
            /*transform: translateX(-50%);  Centers the form horizontally */
            z-index: 1000; /* Ensures the form appears above the map */
            background: rgba(255, 255, 255, 0.8); /* Semi-transparent background */
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            width: 25.85vw;
        }
        #search-message-container {
            position: absolute;
            top: 90px; /* Center vertically */
            left: 47%; /* Center horizontally */
            z-index: 1000;
            width: 500px; /* Adjust width as needed */
            /* background-color: brown; */
            /* height: 10px; Adjust height as needed */
            margin-top: 30px;
            transform: translate(-50%, -50%); /* Adjust position to truly center based on its own size */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .fade-in {
            animation: fadeIn 1s forwards;
        }

        .fade-out {
            animation: fadeOut 1s forwards;
        }

        @media (max-width: 768px) {
            .filter-container {
                width: 100%;
                position: static;
            }
            #search-message-container {
                width: 300px;
            }
        }
    </style>
</head>
<div class="flex-container">
    <div class="map-container">
        <div id="map">
        </div>
        <div class="filter-container">
            <form>
                <div class="form-group">
                    <label for="trip-source">From:</label>
                    <input type="text" class="form-control" id="trip-source" name="trip-source" required>
                </div>
                
                <div class="form-group">
                    <label for="trip-destination">To:</label>
                    <input type="text" class="form-control" id="trip-destination" name="trip-destination" required>
                </div>

            </form>
            <button class="btn btn-primary" onclick="findRoutes()">Search</button> 
            <div id="controls">
                <button class="btn btn-primary" id="locate-btn">Show Me at the Map</button>
            </div>
        </div>   
        <div id="search-message-container">
        </div>    
    </div>
    <script>
        //FIND ROUTES SCRIPT
        function findRoutes() {
            let source = document.getElementById('trip-source').value;
            let destination = document.getElementById('trip-destination').value;
            
            displaySearchErrorMsg();

            $.ajax({
                url: "/TODO", 
                type: "GET",
                success: function(response) {
                    //TODO
                },
                error: function(error) {
                    displaySearchErrorMsg();
                }
            });
            

        }

        function displaySearchErrorMsg() {
            let errorDiv = `<div class="alert alert-danger fade-in" role="alert">Could not find routes</div>`;
            document.getElementById('search-message-container').innerHTML = errorDiv;

            setTimeout(() => {
                let container = document.getElementById('search-message-container');
                container.firstChild.classList.remove('fade-in');
                container.firstChild.classList.add('fade-out');

                setTimeout(() => {
                    container.innerHTML = '';
                }, 1000);
            }, 2500);
        }

        
        //MAP SCRIPT
        // Initialize the map
        var map = L.map('map').setView([51.505, -0.09], 2);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Fetch shapes data from the server
        fetch("{% url 'shapes_json' %}")
            .then(response => response.json())
            .then(data => {
                data.forEach(function(shape) {
                    var lat = shape.fields.shape_pt_lat;
                    var lon = shape.fields.shape_pt_lon;
                    L.marker([lat, lon]).addTo(map)
                        .bindPopup(`Shape ID: ${shape.fields.shape_id}, Sequence: ${shape.fields.shape_pt_sequence}`);
                });
            });

        // Fetch stops data from the server
        fetch("{% url 'stops_json' %}")
            .then(response => response.json())
            .then(data => {
                data.forEach(function(stop) {
                    var lat = stop.fields.stop_lat;
                    var lon = stop.fields.stop_lon;
                    L.marker([lat, lon], {icon: L.icon({iconUrl: 'https://maps.google.com/mapfiles/kml/shapes/bus.png', iconSize: [32, 32]})}).addTo(map)
                        .bindPopup(`Stop ID: ${stop.fields.stop_id}, Stop Name: ${stop.fields.stop_name}`);
                });
            });

        // Handle "Show Me at the Map" button click
        document.getElementById('locate-btn').addEventListener('click', function() {
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    map.setView([lat, lon], 13);
                    L.marker([lat, lon]).addTo(map)
                        .bindPopup('You are here!').openPopup();
                }, function(error) {
                    alert('Geolocation failed: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        });
    </script>

    
</div>
{% endblock %}
